# C++ to Rust FFI Demo with cxx::bridge

A production-ready demonstration of calling Rust code from C++ using the `cxx` crate for safe, ergonomic FFI.

## üéØ Key Features

- ‚úÖ **Type-safe bindings** - Compile-time safety from both languages
- ‚úÖ **Automatic string conversion** - `String` ‚Üî `std::string` handled seamlessly
- ‚úÖ **No unsafe code** - Rust implementation is 100% safe
- ‚úÖ **C++ structs passed to Rust** - Direct structure passing
- ‚úÖ **Modern C++17** - Uses designated initializers
- ‚úÖ **Zero-copy where possible** - Efficient data handling

## üöÄ Quick Start

```bash
# Build and run
cd rust-lib && cargo build --release
cd .. && cmake -S . -B build && cmake --build build
./build/demo
```

## üìã Prerequisites

- **Rust** 1.70+ - Install from [rustup.rs](https://rustup.rs/)
- **Xcode Command Line Tools** - `xcode-select --install`
- **CMake** 3.15+ - `brew install cmake`

## üîß Project Structure

```
cpp-rust-ffi-demo/
‚îú‚îÄ‚îÄ .cargo/
‚îÇ   ‚îî‚îÄ‚îÄ config.toml          # Configures Xcode compiler (IMPORTANT!)
‚îú‚îÄ‚îÄ rust-lib/
‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml            # Rust package with cxx dependency
‚îÇ   ‚îú‚îÄ‚îÄ build.rs              # cxx-build configuration
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ lib.rs            # Rust implementation with #[cxx::bridge]
‚îú‚îÄ‚îÄ cpp-app/
‚îÇ   ‚îî‚îÄ‚îÄ main.cpp              # C++ application
‚îú‚îÄ‚îÄ CMakeLists.txt            # Build configuration
‚îî‚îÄ‚îÄ README.md
```

## üí° How It Works

### Rust Side

```rust
#[cxx::bridge]
mod ffi {
    // Shared struct (visible to both C++ and Rust)
    struct Person {
        age: u32,
        height: f64,
        name: String,  // Automatic String conversion!
    }

    extern "Rust" {
        fn process_person(person: &Person) -> PersonInfo;
    }
}

// Implementation - NO unsafe keyword!
fn process_person(person: &ffi::Person) -> ffi::PersonInfo {
    // Direct access to person.name as String
    let name_length = person.name.len();
    // ...
}
```

### C++ Side

```cpp
#include "rust-lib/src/lib.rs.h"  // Auto-generated by cxx

int main() {
    // Create struct in C++
    Person person{
        .age = 25,
        .height = 1.75,
        .name = rust::String("Bob")
    };
    
    // Call Rust function - type-safe!
    PersonInfo info = process_person(person);
    
    std::cout << "Is adult: " << info.is_adult << std::endl;
}
```

## üèóÔ∏è Building

### Option 1: Manual Build

```bash
# 1. Build Rust library
cd rust-lib
cargo build --release
cd ..

# 2. Build C++ application
cmake -S . -B build
cmake --build build

# 3. Run
./build/demo
```

### Option 2: Use Build Script

```bash
./build.sh
```

## ‚úÖ Testing

```bash
cd rust-lib
cargo test
```

Output:
```
running 5 tests
test tests::test_calculate_bmi ... ok
test tests::test_greet_person ... ok
test tests::test_process_person_minor ... ok
test tests::test_process_person_adult ... ok
test tests::test_greet_empty ... ok

test result: ok. 5 passed; 0 failed; 0 ignored
```

## üìñ Example Output

```
C++ ‚Üî Rust FFI Demo using cxx::bridge

Demonstrating: C++ passing structures to Rust

--- Example 1: String Handling ---
Hello from Rust, Alice!
Returned name length: 5

--- Example 2: Adult Person (C++ struct ‚Üí Rust) ---

=== Person Information ===
Name: Bob Johnson
Name length: 11
Is adult: Yes
BMI category: Normal
=========================

[... more examples ...]

‚úÖ Demo completed successfully!

Key Features Demonstrated:
  ‚úì C++ structures passed to Rust functions
  ‚úì Automatic String ‚Üî std::string conversion
  ‚úì Type-safe interface (compile-time checked)
  ‚úì No raw pointers or unsafe code needed
  ‚úì Modern C++ ergonomics
```

## üîë Key Implementation Details

### Compiler Configuration

The `.cargo/config.toml` file is **critical** - it ensures Xcode's compiler is used instead of Homebrew's:

```toml
[env]
CXX = "/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang++"
CC = "/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang"
```

### String Handling

cxx provides automatic conversion between Rust `String` and C++ types:

| Rust Type | C++ Type | Conversion |
|-----------|----------|------------|
| `String` | `rust::String` | Automatic |
| `&str` | `rust::Str` | Automatic |
| `String` | `std::string` | Via constructor |

### Struct Sharing

Structs defined in the `#[cxx::bridge]` block are:
- Generated in both Rust and C++
- Binary compatible (same memory layout)
- Type-checked by both compilers

## üÜö Comparison with Manual FFI

| Feature | Manual FFI | cxx::bridge |
|---------|------------|-------------|
| **String Handling** | Manual `CString` | Automatic |
| **Unsafe Code** | Required | Not needed |
| **Type Safety** | Manual | Compile-time |
| **Struct Definitions** | Duplicate | Single source |
| **Maintenance** | Keep in sync | Automatic |
| **Error Detection** | Runtime | Compile-time |

## üìö API Reference

### Rust Functions

```rust
fn process_person(person: &Person) -> PersonInfo
```
Analyzes a person's data and returns computed information.

```rust
fn greet_person(name: &str) -> usize
```
Prints a greeting and returns the name length.

```rust
fn calculate_bmi(weight_kg: f64, height_m: f64) -> f64
```
Calculates Body Mass Index from weight and height.

## üêõ Troubleshooting

### Build fails with "file not found: rust-lib/src/lib.rs.h"

**Solution:** Build the Rust library first:
```bash
cd rust-lib && cargo build --release
```

### Build fails with header conflicts

**Solution:** Make sure `.cargo/config.toml` exists and contains the Xcode compiler paths.

### Linking errors on macOS

**Solution:** The CMakeLists.txt includes necessary frameworks. If issues persist:
```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
```

## üìù Documentation

- **[SOLUTION.md](SOLUTION.md)** - Detailed explanation of the implementation
- **[cxx Documentation](https://cxx.rs/)** - Official cxx crate docs
- **[Rust FFI Guide](https://doc.rust-lang.org/nomicon/ffi.html)** - Advanced FFI topics

## üéì Learning Resources

- [cxx Tutorial](https://cxx.rs/tutorial.html) - Step-by-step guide
- [Rust Book - FFI](https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html)
- [C++ Interop Best Practices](https://cxx.rs/binding.html)

## ü§ù Contributing

This is a demonstration project for educational purposes.

## üìÑ License

MIT License - Free to use for learning and commercial purposes.

## üéØ Key Takeaway

Using `cxx::bridge` for C++/Rust FFI provides:
- **Safety** - Type errors caught at compile time
- **Convenience** - No manual type conversions
- **Performance** - Zero-cost abstractions
- **Maintainability** - Single source of truth

**No workarounds needed. Just proper configuration.**
